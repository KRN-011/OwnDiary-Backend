generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =======================================================
// USER MODEL
// =======================================================

model User {
  id                    String          @id @default(uuid())
  username              String          @unique
  email                 String          @unique
  hashedPassword        String
  createdAt             DateTime        @default(now())

  expenses              Expense[]
  trades                Trade[]
  expenseCategories     ExpenseCategory[]
  expenseGroups         ExpenseGroup[]
  brokers               Broker[]
  symbols               Symbol[]
}

// =======================================================
// EXPENSE MODEL
// =======================================================

model Expense {
  id                    String          @id @default(uuid())
  title                 String
  description           String?
  amount                Float

  imageAttachments      String[]            // S3 / Supabase URLs

  userId                String
  user                  User            @relation(fields: [userId], references: [id]) 

  categoryId            String?
  category              ExpenseCategory?     @relation(fields: [categoryId], references: [id])

  parentId              String?
  parent                Expense?        @relation("SubExpenses", fields: [parentId], references: [id])
  subExpenses           Expense[]       @relation("SubExpenses")  
  
  groupId               String?
  group                 ExpenseGroup?   @relation(fields: [groupId], references: [id])

  expenseDate           DateTime        @default(now())
  
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  @@index([userId])
  @@index([parentId])
}

model ExpenseGroup {
  id                    String          @id @default(uuid())
  title                 String          
  description           String?
  amount                Float

  frequencyType         FrequencyType
  interval              Int?
  daysOfWeek            Days[]
  dayOfMonth            Int?

  startDate             DateTime
  endDate               DateTime?

  categoryId            String?
  category              ExpenseCategory?     @relation(fields: [categoryId], references: [id])

  userId                String
  user                  User            @relation(fields: [userId], references: [id])

  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  expenses              Expense[]

  @@index([userId])
}

model ExpenseCategory {
  id                    String          @id @default(uuid())
  name                  String
  icon                  String?

  userId                String
  user                  User            @relation(fields: [userId], references: [id])

  expenses              Expense[]
  expenseGroups         ExpenseGroup[]

  @@unique([userId, name])
}

enum FrequencyType {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}

// =======================================================
// TRADE MODEL
// =======================================================

enum TradeType {
  BUY
  SELL
}

enum TradeSegment {
  EQUITY
  FNO
  CURRENCY
  CRYPTO
  COMMODITY
}

model Trade {
  id                  String          @id @default(uuid())
  date                DateTime
  day                 Days
  time                String

  symbolId            String?          
  symbol              Symbol?         @relation(fields: [symbolId], references: [id])

  segment             TradeSegment
  tradeType           TradeType

  entryPrice          Float
  quantity            Int
  stoplossPrice       Float?
  exitPrice           Float?

  brokerage           Float           @default(0)
  netProfit           Float

  isRulesFollowed     Boolean
  remarkOnTrade       String?

  brokerId            String?
  broker              Broker?         @relation(fields: [brokerId], references: [id])

  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  userId              String
  user                User            @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([date])
}

model Broker {
  id                  String          @id @default(uuid())
  name                String
  isDefault           Boolean         @default(false)
  userId              String?
  user                User?           @relation(fields: [userId], references: [id])

  trades              Trade[]

  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  @@index([userId])
  @@unique([name, userId])
}

model Symbol {
  id        String   @id @default(uuid())
  name      String
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  trades    Trade[]

  createdAt DateTime @default(now())

  @@unique([userId, name])
}

// =======================================================
// GENERAL ENUMS
// =======================================================

enum Days {
  MON
  TUES
  WEDNES
  THURS
  FRI
  SATUR
  SUN
}